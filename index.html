<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="app-version" content="0.0">
    <title>Spanisch-Lern-App [ASCII-ONLY]</title>
    
    <!-- Preload critical resources for performance -->
    <link rel="preload" href="css/style.css" as="style">
    <link rel="preload" href="js/app.js" as="script">
    <link rel="preload" href="js/srs.js" as="script">
    <link rel="preload" href="data/items.json" as="fetch" crossorigin>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#22273a">
    <meta name="description" content="ASCII-only Spanish learning app with SRS, no gamification">
    <!-- No-Gamification Build Guard CSS -->
    <style>
        .nogame-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            background: linear-gradient(90deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .nogame-banner.show {
            transform: translateY(0);
        }
        .nogame-banner a {
            color: #fff;
            text-decoration: underline;
            margin-left: 10px;
        }
        .nogame-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .nogame-status.clean {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .nogame-status.violation {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        body.nogame-blocked {
            pointer-events: none;
            filter: blur(2px);
        }
        .nogame-banner ~ * {
            margin-top: 60px;
        }
        /* ASCII compliance notice */
        .ascii-notice {
            background: #e7f3ff;
            border: 1px solid #0056b3;
            color: #0056b3;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: center;
        }
        /* ASCII status indicator */
        .ascii-status {
            position: fixed;
            top: 50px;
            right: 10px;
            z-index: 9998;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .ascii-status.compliant {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .ascii-status.non-compliant {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Skip link for keyboard navigation -->
    <a href="#app-main" class="skip-link">Skip to main content</a>
    
    <!-- ARIA live region for screen reader announcements -->
    <div id="aria-live-region" role="status" aria-live="polite" aria-atomic="true"></div>
    
    <!-- ASCII Compliance Notice -->
    <div class="ascii-notice">
        ‚ö†Ô∏è ASCII-ONLY Version: Deutsche Umlaute normalisiert (ae, oe, ue, ss)
    </div>

    <!-- No-Gamification Status Banner -->
    <div id="nogame-banner" class="nogame-banner">
        üõ°Ô∏è GAMIFICATION ERKANNT - BUILD BLOCKIERT
        <a href="test.html" target="_blank">‚Üí Test Report</a>
    </div>
    
    <!-- No-Gamification Status Indicator -->
    <div id="nogame-status" class="nogame-status clean">
        ‚úÖ Clean
    </div>

    <!-- ASCII Compliance Status -->
    <div id="ascii-status" class="ascii-status compliant">
        üî§ ASCII-OK
    </div>

    <header class="app-header" role="banner">
        <div id="debug-toolbar" role="toolbar" aria-label="Debug controls">
            <select id="debug-mode-select" aria-label="Learning mode">
                <option value="learn">Lernen</option>
                <option value="srs">Ueben</option>
                <option value="conjugation">Konjugation</option>
                <option value="free-pick">Freie Wahl</option>
            </select>
            <select id="debug-force-type-select">
                <option value="">Typ erzwingen</option>
                <option value="choice">Multiple Choice</option>
                <option value="typing">Luecke</option>
                <option value="conjugation">Konjugation</option>
                <option value="sentence">Satz</option>
                <option value="match">Match</option>
            </select>
            <label>SRS: <input type="checkbox" id="debug-srs-toggle" checked></label>
            <button id="debug-srs-reset-box">Box 0</button>
            <button id="debug-srs-due-now">Faellig</button>
            <button id="debug-db-reimport">DB Re-Import</button>
            <button id="ascii-migrate-btn">ASCII Migration</button>
            <button id="ascii-verify-btn">ASCII Verify</button>
            <button id="conjugator-test-btn">Test Konjugator</button>
            <button id="zeiten-workbench-btn" onclick="window.open('zeiten-workbench.html', '_blank')">üìö Zeiten-Workbench</button>
            <button id="zeiten-uebungen-btn" onclick="window.open('zeiten-uebungen.html', '_blank')">üéØ Zeiten-Uebungen</button>
            <button id="explain-test-btn" onclick="window.open('explain-test.html', '_blank')">üîç Fehlererklaerungen</button>
            <button id="sentence-analyzer-btn" onclick="window.open('sentence-analyzer-test.html', '_blank')">üìù Satzanalyse</button>
            <button id="verb-pack-btn" onclick="window.open('verb-pack-test.html', '_blank')">üì¶ Verb-Packs</button>
            <button id="periphrastic-btn" onclick="window.open('periphrastic-test.html', '_blank')">üîÑ Periphrasen</button>
            <button id="timeline-btn" onclick="window.open('timeline-view.html', '_blank')">‚è∞ Zeitachse</button>
            <button id="diagnostic-btn" onclick="window.open('diagnostic-test.html', '_blank')">üîç Diagnose</button>
            <button id="csv-import-btn" onclick="window.open('csv-import-export.html', '_blank')">üìÅ CSV Import</button>
        </div>
        <div class="settings-container">
            <button id="dark-mode-toggle" aria-label="Dark Mode umschalten">üåô</button>
        </div>
    </header>

    <main id="app-main" class="app-main" role="main">
        <div id="exercise-container" class="exercise-container" role="region" aria-label="Exercise area"></div>
        <div id="feedback-container" class="feedback-container" role="region" aria-label="Feedback area" aria-live="polite"></div>
        <div id="free-pick-container" class="free-pick-container" style="display: none;">
            <h2>Freie Auswahl</h2>
            <div class="filters">
                <input type="text" id="free-pick-filter-text" placeholder="Text filtern...">
                <select id="free-pick-filter-tag"><option value="">Tag...</option></select>
            </div>
            <ul id="free-pick-list"></ul>
        </div>
    </main>

    <footer id="app-footer" class="app-footer" role="contentinfo">
        <div id="status-bar" role="status" aria-live="polite"></div>
        <button id="check-btn" class="footer-btn" aria-label="Check answer or proceed to next exercise">Ueberpruefen</button>
        <button id="repeat-item-btn" class="footer-btn-secondary" style="display: none;" aria-label="Repeat current item">Item wiederholen</button>
        <button id="repeat-round-btn" class="footer-btn-secondary" style="display: none;" aria-label="Repeat current round">Runde wiederholen</button>
    </footer>

    <div id="error-overlay" style="display: none;">
        <div class="error-content">
            <h2>Unhandled Error</h2>
            <pre id="error-stack"></pre>
            <textarea id="error-state-dump"></textarea>
            <button id="error-copy-btn">Copy</button>
            <button id="error-close-btn">Close</button>
        </div>
    </div>

    <!-- ASCII Normalization Utils -->
    <script src="js/utils/ascii.js"></script>
    
    <!-- Performance Utilities -->
    <script src="js/utils/performance.js"></script>
    
    <!-- A11y & Performance Hardening -->
    <script src="js/utils/a11y-perf-hardening.js"></script>
    
    <!-- Spanish Normalization -->
    <script src="js/normalize-es.js"></script>
    
    <!-- Conjugation System -->
    <script src="js/conjugator.js"></script>
    
    <!-- Migration Tools -->
    <script src="js/utils/migrator.js"></script>

    <!-- Final Verification -->
    <script src="js/utils/final-verification.js"></script>

    <!-- Verb Build Reporter -->
    <script src="js/utils/verb-build-reporter.js"></script>
    
    <!-- Error Explainer System -->
    <script src="js/explain.js"></script>
    <script src="js/explain-ui.js"></script>
    
    <!-- Sentence Analyzer -->
    <script src="js/sentence-analyzer.js"></script>
    
    <!-- Verb Pack System -->
    <script src="js/verb-pack-system.js"></script>
    
    <!-- Periphrastic System -->
    <script src="js/periphrastic-system.js"></script>
    
    <!-- No-Gamification Build Guard -->
    <script src="js/no-gamification.lint.js"></script>
    <script src="test/nogame-dom-spec.js"></script>
    <script src="test/nogame-db-spec.js"></script>
    <script>
        // No-Gamification Build Guard - Auto-run on page load
        class BuildGuard {
            constructor() {
                this.banner = document.getElementById('nogame-banner');
                this.status = document.getElementById('nogame-status');
                this.isBlocked = false;
            }

            async runGuard() {
                try {
                    console.log('üõ°Ô∏è Running No-Gamification Build Guard...');
                    
                    // Quick lint check
                    const linter = new NoGamificationLinter();
                    const lintResult = await linter.scanWorkspace();
                    
                    // Quick DOM check
                    const domGuard = new NoGamificationDOMGuard();
                    const domResult = await domGuard.scanDOM();
                    
                    // Quick DB check  
                    const dbGuard = new NoGamificationDBGuard();
                    const dbResult = await dbGuard.scanDatabase();
                    
                    const allPassed = lintResult.passed && domResult.passed && dbGuard.passed;
                    const totalViolations = (lintResult.violations?.length || 0) + 
                                          (domResult.violations?.length || 0) + 
                                          (dbResult.violations?.length || 0);
                    
                    if (allPassed) {
                        this.showClean();
                    } else {
                        this.showViolation(totalViolations);
                    }
                    
                    console.log(`üõ°Ô∏è Build Guard: ${allPassed ? 'CLEAN' : 'BLOCKED'} (${totalViolations} violations)`);
                    
                } catch (error) {
                    console.error('Build Guard failed:', error);
                    this.showError(error.message);
                }
            }

            showClean() {
                this.status.className = 'nogame-status clean';
                this.status.textContent = '‚úÖ Clean';
                this.banner.classList.remove('show');
                document.body.classList.remove('nogame-blocked');
                this.isBlocked = false;
            }

            showViolation(count) {
                this.status.className = 'nogame-status violation';
                this.status.textContent = `‚ùå ${count} Violations`;
                this.banner.classList.add('show');
                document.body.classList.add('nogame-blocked');
                this.isBlocked = true;
            }

            showError(message) {
                this.status.className = 'nogame-status violation';
                this.status.textContent = '‚ö†Ô∏è Error';
                console.error('Build Guard Error:', message);
            }
        }

        // ASCII Compliance Guard
        class AsciiComplianceGuard {
            constructor() {
                this.violations = [];
                this.statusElement = document.getElementById('ascii-status');
            }

            async runComplianceCheck() {
                console.group('üî§ ASCII Compliance Check');
                
                try {
                    this.violations = [];
                    
                    // Check current page content
                    this.checkPageContent();
                    
                    // Check UI elements
                    this.checkUIElements();
                    
                    // Update status
                    this.updateStatus();
                    
                    if (this.violations.length === 0) {
                        console.log('‚úÖ ASCII Compliance: All checks passed');
                    } else {
                        console.warn(`‚ùå ASCII Compliance: ${this.violations.length} violations found`);
                        this.violations.forEach(v => console.warn(v));
                    }
                    
                } catch (error) {
                    console.error('ASCII compliance check failed:', error);
                }
                
                console.groupEnd();
            }

            checkPageContent() {
                try {
                    const pageText = document.body.innerText;
                    const violations = asciiNormalizer.scanForViolations(pageText);
                    
                    if (violations.length > 0) {
                        this.violations.push({
                            type: 'page-content',
                            violations,
                            message: 'German umlauts found in page content'
                        });
                    }
                } catch (error) {
                    console.warn('Could not check page content:', error);
                }
            }

            checkUIElements() {
                // Check common UI elements for ASCII compliance
                const elementsToCheck = [
                    '#status-bar',
                    '#check-btn',
                    '#repeat-item-btn',
                    '#repeat-round-btn',
                    '.exercise-type',
                    '.direction',
                    '.feedback-text'
                ];

                elementsToCheck.forEach(selector => {
                    try {
                        const element = document.querySelector(selector);
                        if (element && element.textContent) {
                            const violations = asciiNormalizer.scanForViolations(element.textContent);
                            if (violations.length > 0) {
                                this.violations.push({
                                    type: 'ui-element',
                                    selector,
                                    violations,
                                    text: element.textContent
                                });
                            }
                        }
                    } catch (error) {
                        // Element not found, ignore
                    }
                });
            }

            updateStatus() {
                if (this.statusElement) {
                    if (this.violations.length === 0) {
                        this.statusElement.className = 'ascii-status compliant';
                        this.statusElement.textContent = 'üî§ ASCII-OK';
                    } else {
                        this.statusElement.className = 'ascii-status non-compliant';
                        this.statusElement.textContent = `üî§ ${this.violations.length} Issues`;
                    }
                }
            }
        }

        // Initialize guards
        let buildGuard;
        let asciiGuard;
        
        document.addEventListener('DOMContentLoaded', () => {
            buildGuard = new BuildGuard();
            asciiGuard = new AsciiComplianceGuard();
            
            // Run guards after a short delay
            setTimeout(async () => {
                await buildGuard.runGuard();
                await asciiGuard.runComplianceCheck();
            }, 1000);
            
            // Re-run guards when page becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    setTimeout(async () => {
                        await buildGuard.runGuard();
                        await asciiGuard.runComplianceCheck();
                    }, 100);
                }
            });

            // ASCII Migration Button
            const migrateBtnElement = document.getElementById('ascii-migrate-btn');
            if (migrateBtnElement) {
                migrateBtnElement.addEventListener('click', async () => {
                    try {
                        console.log('üîÑ Starting ASCII migration...');
                        const migrator = new DataMigrator();
                        await migrator.migrateItemsJson();
                        
                        // Refresh app after migration
                        if (window.app) {
                            window.app.loadVocabulary();
                        }
                    } catch (error) {
                        console.error('Migration failed:', error);
                        alert('Migration fehlgeschlagen: ' + error.message);
                    }
                });
            }

            // ASCII Verification Button
            const verifyBtnElement = document.getElementById('ascii-verify-btn');
            if (verifyBtnElement) {
                verifyBtnElement.addEventListener('click', async () => {
                    try {
                        console.log('üîç Starting comprehensive ASCII verification...');
                        const verifier = new FinalAsciiVerification();
                        const results = await verifier.runFullVerification();
                        
                        if (results.overallPassed) {
                            alert('‚úÖ ASCII Verification PASSED! Check console for details.');
                        } else {
                            alert('‚ùå ASCII Verification FAILED! Check console for details.');
                        }
                    } catch (error) {
                        console.error('Verification failed:', error);
                        alert('Verification fehlgeschlagen: ' + error.message);
                    }
                });
            }

            // Conjugator Test Button
            const conjugatorTestBtnElement = document.getElementById('conjugator-test-btn');
            if (conjugatorTestBtnElement) {
                conjugatorTestBtnElement.addEventListener('click', async () => {
                    try {
                        console.log('üî§ Starting comprehensive conjugator tests...');
                        if (window.app && window.app.conjugatorLoaded) {
                            
                            // Initialize build reporter
                            const reporter = new VerbBuildReporter(window.app.conjugator);
                            
                            // Generate comprehensive report
                            const report = await reporter.generateBuildReport();
                            
                            // Print summary to console
                            reporter.printSummary(report);
                            
                            // Show user feedback
                            const status = report.summary?.overallStatus || 'UNKNOWN';
                            const verbCount = report.summary?.verbsLoaded || 0;
                            const conjugationRate = report.summary?.conjugationSuccessRate || 0;
                            const analysisRate = report.summary?.analysisAccuracyRate || 0;
                            
                            let message = `üî§ CONJUGATOR BUILD REPORT\\n\\n`;
                            message += `Status: ${status}\\n`;
                            message += `Verbs: ${verbCount}\\n`;
                            message += `Conjugation Success: ${conjugationRate.toFixed(1)}%\\n`;
                            message += `Analysis Accuracy: ${analysisRate.toFixed(1)}%\\n\\n`;
                            message += `Detailed report saved as verb-build-report.json\\n`;
                            message += `Check console for full details.`;
                            
                            alert(message);
                            
                        } else {
                            alert('‚ùå Conjugator not loaded yet.');
                        }
                    } catch (error) {
                        console.error('Conjugator test failed:', error);
                        alert('‚ùå Conjugator test failed: ' + error.message);
                    }
                });
            }
        });

        // Periodic guard check (every 30 seconds)
        setInterval(async () => {
            if (buildGuard && asciiGuard && !document.hidden) {
                await buildGuard.runGuard();
                await asciiGuard.runComplianceCheck();
            }
        }, 30000);
    </script>

    <script src="js/srs.js"></script>
    <script src="js/app.js"></script>
</body>
</html>